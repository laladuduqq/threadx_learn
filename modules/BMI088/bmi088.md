<!--
 * @Author: laladuduqq 2807523947@qq.com
 * @Date: 2025-08-05 22:46:17
 * @LastEditors: laladuduqq 2807523947@qq.com
 * @LastEditTime: 2025-08-06 08:52:30
 * @FilePath: /threadx_learn/modules/BMI088/bmi088.md
 * @Description: BMI088 IMU传感器驱动文档
-->

# BMI088 IMU传感器驱动文档

## 简介

BMI088是一款高性能6轴惯性测量单元(IMU)，包含一个3轴加速度计和一个3轴陀螺仪。该驱动程序基于ThreadX实时操作系统和STM32 HAL库开发，提供了完整的传感器初始化、数据采集和温度控制功能。

## 特性

1. **完整的传感器初始化**：
   
   - 自动识别传感器ID
   - 加速度计和陀螺仪独立配置
   - 内置自检功能
   - 校准功能

2. **数据采集**：
   
   - 3轴加速度数据
   - 3轴角速度数据
   - 温度数据

3. **温度控制**：
   
   - PWM控制加热元件
   - PID温度调节
   - 自动校准功能

4. **ThreadX集成**：
   
   - 使用BSP_SPI接口进行通信
   - 使用BSP_PWM进行温度控制
   - 支持多任务环境

## 硬件连接

- **SPI接口**：BMI088通过SPI总线与MCU通信
  
  - SCK: SPI时钟线
  - MOSI: 主机输出从机输入数据线
  - MISO: 主机输入从机输出数据线
  - CSB1: 陀螺仪片选信号(GPIOB_PIN_0)
  - CSB2: 加速度计片选信号(GPIOA_PIN_4)

- **电源**：3.3V供电

## API接口说明

### 主要函数

#### `void BMI088_init(void)`

BMI088初始化函数，完成以下操作：

1. 初始化SPI设备（陀螺仪和加速度计）
2. 配置传感器寄存器
3. 执行自检程序
4. 初始化温度控制PWM
5. 读取或执行校准程序

#### `BMI088_GET_Data_t BMI088_GET_DATA(void)`

获取传感器数据，返回包含加速度和角速度的结构体。

#### `void bmi088_temp_ctrl(void)`

温度控制函数，根据PID算法调节加热PWM占空比以维持恒定温度。

### 数据结构

#### [BMI088_Data_t](file:///home/pan/code/threadx_learn/modules/BMI088/BMI088.h#L21-L33)

内部数据结构，包含：

- `float gyro[3]`: 三轴角速度数据
- `float acc[3]`: 三轴加速度数据
- `float temperature`: 当前温度
- `float TempWhenCali`: 校准时候的温度
- `PIDInstance imu_temp_pid`: 温度控制PID实例
- `float AccelScale`: 加速度计缩放因子
- `float GyroOffset[3]`: 陀螺仪零偏
- `float gNorm`: 重力加速度模长

#### [BMI088_GET_Data_t](file:///home/pan/code/threadx_learn/modules/BMI088/BMI088.h#L35-L39)

外部数据接口结构体：

- `const float (*gyro)[3]`: 三轴角速度数据指针
- `const float (*acc)[3]`: 三轴加速度数据指针

## 配置参数

### 传感器配置

- **加速度计量程**：±6g
- **加速度计输出数据速率**：800Hz
- **陀螺仪量程**：±2000°/s
- **陀螺仪带宽**：116Hz
- **工作模式**：正常模式

### 温度控制配置

- **目标温度**：40°C（校准期间）
- **工作温度**：校准温度±少量波动
- **PWM频率**：5kHz
- **PID参数**：
  - Kp: 20
  - Ki: 1
  - Kd: 0
  - 最大输出: 100
  - 积分限幅: 20

## 校准流程

BMI088驱动包含自动校准功能：

1. **温度稳定**：
   
   - 启动加热器将传感器加热至30°C
   - 等待温度稳定（误差<0.5°C）

2. **数据采集**：
   
   - 采集6000组数据样本
   - 记录陀螺仪零偏
   - 计算重力加速度模长

3. **校准验证**：
   
   - 检查重力加速度是否接近9.8m/s²
   - 检查陀螺仪零偏是否在合理范围内
   - 验证数据稳定性

4. **数据存储**：
   
   - 将校准数据保存到Flash中
   - 下次上电时直接使用校准数据

## 使用示例

```c
#include "BMI088.h"

// 在系统初始化线程中
void system_init_thread(ULONG thread_input) {
    // 初始化BMI088传感器
    BMI088_init();

    // 主循环
    while(1) {
        // 获取传感器数据
        BMI088_GET_Data_t sensor_data = BMI088_GET_DATA();

        // 控制温度
        bmi088_temp_ctrl();

        // 使用数据进行处理
        float ax = (*sensor_data.acc)[0];
        float ay = (*sensor_data.acc)[1];
        float az = (*sensor_data.acc)[2];
        float gx = (*sensor_data.gyro)[0];
        float gy = (*sensor_data.gyro)[1];
        float gz = (*sensor_data.gyro)[2];

        // 延时
        tx_thread_sleep(1);
    }
}
-->
```

## 注意事项

1. **初始化时机**：
   
   - 必须在ThreadX系统完全启动后才能初始化BMI088
   - 初始化过程涉及SPI通信和互斥锁操作

2. **中断处理**：
   
   - SPI通信期间会禁用中断以保证数据完整性
   - 应尽量缩短中断禁用时间

3. **温度控制**：
   
   - PID参数可能需要根据具体硬件调整
   - 加热元件功率不宜过大，避免过热

4. **校准数据**：
   
   - 校准数据保存在Flash中
   - 如果校准失败，会使用默认值

## 故障排除

### 常见问题

1. **传感器无法识别**：
   
   - no acc sensor 报错，在频繁reset时会出现，没有影响，无视即可

2. **数据异常**：
   
   - 重新执行校准程序
   - 确认温度是否稳定

3. **温度控制失效**：
   
   - 检查是否24v供电，加热电路需要5v才能正常工作
   - 调整PID参数
   - 检查PWM输出是否正常

### 错误码说明

- `BMI088_NO_ERROR`: 无错误
- `BMI088_ACC_PWR_CTRL_ERROR`: 加速度计电源控制错误
- `BMI088_ACC_PWR_CONF_ERROR`: 加速度计电源配置错误
- `BMI088_ACC_CONF_ERROR`: 加速度计配置错误
- `BMI088_ACC_RANGE_ERROR`: 加速度计量程配置错误
- `BMI088_GYRO_RANGE_ERROR`: 陀螺仪量程配置错误
- `BMI088_NO_SENSOR`: 未检测到传感器
- `BMI088_SELF_TEST_ACCEL_ERROR`: 加速度计自检失败
- `BMI088_SELF_TEST_GYRO_ERROR`: 陀螺仪自检失败
